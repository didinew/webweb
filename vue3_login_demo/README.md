## Web3 登录（前后端交互）

**核心要点**
- Nonce 一次性挑战串，防重放与伪造，必须先取再签
- 私钥不出端：本地钱包签名，后端仅验签与地址匹配
- 错误可视化：网络失败/拒签统一提示，交互清晰

**面试常问**
- 为什么不用钱包地址直接登录？→ Nonce + 签名证明私钥控制权
- 为什么还要 JWT？→ Web3 负责身份认证，会话管理交给 JWT
- 会不会扣钱？→ signMessage 不是交易，不上链，无 gas

**SIWE（EIP‑4361）标准登录**
- 防钓鱼：结构化消息包含域分隔与用途说明
- 文本结构标准化：签名内容可读、可审计
- 钱包 UI 明确提示“Sign‑In With Ethereum”

**登录签名 vs 授权交易**

| 行为        | 是否上链 | 是否扣钱 |
|-------------|----------|----------|
| signMessage | 否       | 否       |
| approve     | 是       | 否       |
| transfer    | 是       | 是       |

提示：登录签名仅用于身份确认，不产生任何链上状态变更。

**终极面试回答**
- 采用 EIP‑4361 或自定义 nonce 机制，用户用钱包对登录消息签名
- 后端用 `verifyMessage`/`ecrecover` 验证地址控制权，成功后签发 JWT 维持会话
- 全流程不暴露私钥、不上链，nonce 防重放，登录签名与授权交易严格区分

**一句话总结**
- 使用钱包对后端生成的 nonce 进行签名，后端验证地址控制权，校验成功后签发 JWT 维持会话

六、进阶升级（实战全家桶）

A️⃣ SIWE（EIP-4361）标准登录（行业标准）

为什么要 SIWE？

防钓鱼

文本结构标准化

钱包 UI 会明确显示“Sign-In With Ethereum”
2️⃣ 无限授权 vs 登录签名

| 行为        | 是否上链 | 是否扣钱 | 资产风险 |
|-------------|----------|----------|----------|
| signMessage | 否       | 否       | 否       |
| approve     | 是       | 否       | ⚠️       |
| transfer    | 是       | 是       | ✅       |

UI 明确提示：本次签名不产生任何交易

我们使用 EIP-4361 或自定义 nonce 机制，让用户用钱包对登录消息签名， 后端通过 ecrecover 验证地址控制权， 成功后签发 JWT 作为会话凭证。 整个过程不涉及私钥、不上链，通过 nonce 防重放，并明确区分登录签名与授权交易。


十、Web3 登录完整流程图（文字版）
┌──────────┐
│  Browser │
└────┬─────┘
     │ connect wallet
     ▼
┌──────────┐        ① request nonce
│  Frontend│ ─────────────────────▶ Backend
└────┬─────┘        ② generate nonce
     │ ③ sign nonce                 │
     │ signMessage(nonce)            │
     ▼                               │
┌──────────┐        ④ verify sig     │
│  Wallet  │ ─────────────────────▶ Backend
└──────────┘        ⑤ issue JWT      │
                     ▼
                 ┌──────────┐
                 │   JWT    │
                 └──────────┘

一句话记忆：

钱包证明你控制私钥，JWT 证明你已登录

十一、面试官高频追问 Q&A（必杀）

Q1：为什么 Web3 登录还需要后端？

答： 钱包只能证明地址控制权，无法管理会话；后端通过 JWT 统一鉴权，兼容 Web2 体系。

Q2：如果攻击者拿到旧签名怎么办？

答： 每次登录使用一次性 Nonce，校验成功后立即失效，防止重放攻击。

Q3：签名和 approve 有什么区别？

答： 签名不产生链上交易、不消耗 Gas；approve 是链上授权，可能导致资产风险。

Q4：为什么推荐 SIWE？

答： SIWE 对登录消息进行结构化定义，可防钓鱼，钱包 UI 也能明确提示登录目的。

Q5：为什么不用合约账户直接登录？

答： EOA 签名成本低、兼容性最好；合约账户需额外验证逻辑，通常用于更复杂权限场景。

十二、一句话项目总结（终极）

这是一个基于行业标准 SIWE 的 Web3 登录系统，实现了从钱包签名认证到 JWT 会话管理的完整闭环，兼顾安全性、工程化与生产可用性。

	•	❓ 为什么不用地址直接登录
	•	❓ 旧签名攻击怎么办
	•	❓ signMessage vs approve
	•	❓ 为什么要 SIWE
	•	❓ 合约账户能不能登录



⸻

❓ 为什么不用地址直接登录？

✅ 一句话版（标准）

因为地址是公开信息，不能证明你真的控制私钥，必须通过签名来证明身份。

🔍 展开版（追问）
	•	钱包地址是 公开可复制的字符串
	•	任何人都可以声称“我是这个地址”
	•	只有私钥签名才能证明你是真正的控制者
👉 所以 Web3 登录的本质是：
不是“你是谁”，而是“你能不能签名”

⸻

❓ 旧签名攻击怎么办？

✅ 一句话版

使用一次性 Nonce，每次登录只能用一次，防止重放攻击。

🔍 展开版
	•	后端生成 nonce（随机数 / uuid）
	•	用户对 nonce 签名
	•	后端校验成功后 立即销毁 nonce
	•	攻击者就算拿到旧签名也无法再次使用

👉 这是 Web3 登录里最核心的安全设计

⸻

❓ signMessage vs approve 有什么区别？

✅ 一句话版

signMessage 只是链下签名，不上链、不花钱；approve 是链上授权，可能导致资产风险。

🔍 展开版（表格秒杀）

| 行为        | 是否上链 | 是否扣钱 | 资产风险 |
|-------------|----------|----------|----------|
| signMessage | 否       | 否       | 否       |
| approve     | 是       | 否       | ⚠️       |
| transfer    | 是       | 是       | ✅       |

👉 面试官如果问「那你怎么防止钓鱼？」
你可以直接说：

登录只允许 signMessage，绝不请求 approve

⸻

❓ 为什么要 SIWE（EIP-4361）？

✅ 一句话版

SIWE 是 Web3 登录的行业标准，能防钓鱼、让钱包明确展示登录意图。

🔍 展开版
	•	统一消息结构（domain / nonce / issuedAt）
	•	钱包 UI 明确显示：Sign-In With Ethereum
	•	防止“模糊签名文本”诱导用户

👉 你可以补一句加分项：

很多头部项目（OpenSea、Uniswap）都在用 SIWE

⸻

❓ 合约账户能不能登录？

✅ 一句话版

可以，但复杂度更高，默认推荐用 EOA。

🔍 展开版（高级）
	•	EOA：直接 ECDSA 验签，最简单、最通用
	•	合约账户（AA）：
	•	需要合约内实现签名验证逻辑
	•	通常配合 ERC-1271 / ERC-4337
	•	多用于企业账户 / 多签 / 高安全场景

👉 面试加分总结：

登录场景优先 EOA，权限场景才用合约账户

⸻

🎯 终极 30 秒总结（必杀）

Web3 登录不依赖地址本身，而是通过对一次性 nonce 的签名来证明私钥控制权；
签名只发生在链下，不产生交易；
后端验证成功后签发 JWT 管理会话；
为了安全和标准化，推荐使用 SIWE；
默认使用 EOA，合约账户只在复杂权限场景使用