Step 3 是“钱真正开始流动”的地方，也是事故最多的地方。

从这一步开始：
冻结 ≠ 余额 ≠ 成交 ≠ 资产

我会非常慢、非常严。

⸻

💣 Step 3：模拟成交系统（部分成交 + 幂等）

🎯 本 Step 目标

你将实现：
	•	成交事件模型
	•	部分成交
	•	冻结资金按成交逐步释放
	•	订单状态：PARTIALLY_FILLED / FILLED
	•	幂等处理（防 WS 重放）

⸻

一、成交是“事件”，不是函数返回值

📌 这是认知分水岭。
下单 ≠ 成交
成交 = 异步事件


⸻

八、Step 3 验收清单（严）
	•	成交可部分
	•	VWAP 正确
	•	冻结按成交逐步释放
	•	WS 重放不重复结算
	•	订单状态不可逆

一、Step 3 核心目标
	1.	撮合成交（Match Order）
	•	根据订单簿（买卖单）判断价格能否匹配
	•	生成成交记录（Trade）
	2.	更新订单状态
	•	filledQty：累计成交数量
	•	avgPrice：累计成交金额 / 累计成交数量
	•	status：NEW / PARTIALLY_FILLED / FILLED
	3.	保持订单簿正确
	•	完全成交的订单从簿中移除
	•	部分成交的订单仍在簿中等待下次撮合

二、Step 3 流程示意
用户下单 → Step 4 放入订单簿
       ↓
Step 3 撮合逻辑：
  1. 遍历对手方订单簿
  2. 判断价格是否匹配
  3. 计算成交数量 (matchedQty)
  4. 更新买卖双方 filledQty / totalAmount
  5. 更新 avgPrice = totalAmount / filledQty
  6. 更新订单状态
  7. 移除已成交的订单
       ↓
生成成交记录 Trade → Step 5 手续费 & VWAP 计算