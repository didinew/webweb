### Day 5：风控 / 手续费 / 资金冻结

## 你要知道的 CEX 风控
- 下单会冻结资产
- 撤单解冻
- 手续费计算
- 强平逻辑（杠杆）

## 完成今天，你将
- 真正理解 成交价 ≠ 下单价
- 理解 为什么余额总是“少一点”
- 搞清 maker / taker 手续费
- 能用代码 精确算出最终成本

---

## 成交价是怎么“算”的？

**结论**：成交价 = 撮合时对手盘的价格

不是：
- 你点下单那一刻看到的价格
- K 线价格

## 二、市价单成交价（最容易亏）

#### 示例订单簿
```
卖单（Asks）
30100 → 0.05
30110 → 0.03
30120 → 0.02
```

- 你下：市价买 0.10 BTC

#### 成交拆解
```
0.05 × 30100
0.03 × 30110
0.02 × 30120
```

#### 实际成交均价
成交均价 = 成交总金额 / 成交总数量

> 市价单 = 多笔成交的加权平均价（VWAP）

## 三、限价单成交价

#### 情况 1：被动成交（Maker）
- 你挂买 30000
- 有人市价卖
- 成交价 = 30000

#### 情况 2：主动成交（Taker）
- 你挂买 31000
- 卖一是 30100
- 成交价 = 30100

> 限价 ≠ 成交价

## 四、Maker / Taker 到底是谁？

**判断标准**：是否立刻成交

| 行为 | 身份 |
| --- | --- |
| 挂单进簿 | Maker |
| 吃已有单 | Taker |

## 五、手续费是怎么“算”的？
手续费 = 成交额 × 手续费率

## 六、手续费从哪扣？
### 买单（BUY）
- 扣在“买到的币”里
- 例：买 1 BTC，手续费 0.1% → 实得 0.999 BTC

### 卖单（SELL）
- 扣在“卖出得到的钱”里
- 例：卖 1 BTC，得 30000 USDT，手续费 30 USDT

---

## 七、为什么 maker 手续费更低？
| 角色 | 给交易所带来什么 |
| --- | --- |
| Maker | 流动性 |
| Taker | 成交量 |

> 有些平台：Maker 甚至是负手续费（返佣）


⸻

## 八、ccxt 中怎么看真实成交？

#### 订单信息里的关键字段
```js
order.trades   // 成交明细
order.filled   // 成交数量
order.cost     // 成交总金额（不含手续费）
order.fee      // 手续费
order.average  // 成交均价
```

#### 手续费计算验证（你可以自己算）
```js
const cost = order.cost
const feeRate = 0.001
const fee = cost * feeRate
```

## 九、为什么你看到的余额总是“对不上”？
- 多笔成交
- 每笔手续费
- 手续费扣在不同资产
- 冻结 → 结算 → 释放

> 不是 bug，是会计顺序

---

## 十、专业级公式（你可以直接用）
- 买单实际成本 = 成交额 + 手续费（若扣 USDT）
- 卖单实际收入 = 成交额 - 手续费（若扣 USDT）


