Day 3ï½œç­¾å & éªŒç­¾ï¼ˆECDSA + EIP-712ï¼‰

æ ¸å¿ƒä¸€å¥è¯ï¼š
Web3 ä¸–ç•Œæ²¡æœ‰â€œè´¦å·å¯†ç â€ï¼Œ
åªæœ‰â€”â€”ä½ èƒ½ä¸èƒ½ç”¨è¿™ä¸ªç§é’¥ç­¾åã€‚

â¸»

ä¸€ã€ä¸ºä»€ä¹ˆâ€œç­¾åâ€å°±æ˜¯èº«ä»½ï¼Ÿ

ä¼ ç»Ÿç™»å½•

è´¦å· + å¯†ç  â†’ æœåŠ¡å™¨åˆ¤æ–­

Web3 ç™»å½•
ç§é’¥ç­¾å â†’ é“¾ / æœåŠ¡ç«¯æ•°å­¦éªŒè¯

ğŸ‘‰ æ²¡æœ‰æ³¨å†Œ
ğŸ‘‰ æ²¡æœ‰å¯†ç 
ğŸ‘‰ åªæœ‰èƒ½ä¸èƒ½éªŒè¯é€šè¿‡

â¸»

äºŒã€ECDSAï¼šç­¾ååœ¨æ•°å­¦ä¸Šå¹²äº†ä»€ä¹ˆï¼Ÿ

ä¸æ¨å…¬å¼ï¼Œåªè®²ä½ å¿…é¡»æ‡‚çš„å·¥ç¨‹äº‹å®

ç­¾ååšäº†ä¸‰ä»¶äº‹
	1.	ç§é’¥å‚ä¸è®¡ç®—
	2.	ä¸æš´éœ²ç§é’¥
	3.	ç»“æœå¯è¢«ä»»ä½•äººéªŒè¯

message
   â”‚
   â–¼
hash(message)
   â”‚
   â–¼
ECDSA(privateKey)
   â”‚
   â–¼
signature (r,s,v)


â¸»

éªŒç­¾æœ¬è´¨
message + signature
   â”‚
   â–¼
recover address
   â”‚
   â–¼
æ˜¯å¦ == å£°ç§°çš„åœ°å€ï¼Ÿ

ğŸ‘‰ åŒºå—é“¾ ä»ä¸å…³å¿ƒä½ æ˜¯è°
ğŸ‘‰ åªå…³å¿ƒ æ•°å­¦æ˜¯å¦æˆç«‹

â¸»

ä¸‰ã€ä¸‰ç§â€œç­¾åâ€ä½ å¿…é¡»åˆ†æ¸…

1ï¸âƒ£ Message ç­¾åï¼ˆæœ€å¸¸è§ï¼‰

await signer.signMessage("hello")

ç”¨é€”ï¼š
	â€¢	Web3 ç™»å½•
	â€¢	èº«ä»½éªŒè¯
	â€¢	Off-chain æˆæƒ

âš ï¸ é£é™©ï¼šå¯è¢«é‡æ”¾

â¸»

2ï¸âƒ£ Transaction ç­¾åï¼ˆé“¾ä¸Šï¼‰
await signer.sendTransaction({...})

ç”¨é€”ï¼š
	â€¢	è½¬è´¦
	â€¢	è°ƒç”¨åˆçº¦

ç‰¹ç‚¹ï¼š
	â€¢	å« nonce
	â€¢	åªèƒ½æ‰§è¡Œä¸€æ¬¡

â¸»

3ï¸âƒ£ EIP-712ï¼ˆç»“æ„åŒ–ç­¾åï¼‰ğŸ”¥

DeFi æ ‡å‡†
ç­¾åçš„æ˜¯â€œç»“æ„â€ï¼Œä¸æ˜¯å­—ç¬¦ä¸²


â¸»

å››ã€Message ç­¾åå®æ“ï¼ˆNode.jsï¼‰
```js
import { Wallet, verifyMessage } from 'ethers'

const wallet = Wallet.createRandom()
const message = 'Login at 2025-01-01'

const sig = await wallet.signMessage(message)
const recovered = verifyMessage(message, sig)

console.log(recovered === wallet.address) // true
```

âš ï¸ é¢è¯•è¿½é—®ç‚¹

å¦‚æœ message ä¸€æ ·ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

âŒ å¯ä»¥è¢«æ— é™é‡æ”¾
âœ… å¿…é¡»åŠ  nonce / timestamp

â¸»

äº”ã€ä¸ºä»€ä¹ˆè¦ EIP-712ï¼Ÿï¼ˆè®¤çŸ¥è½¬æŠ˜ç‚¹ï¼‰

æ™®é€š message çš„é—®é¢˜

"Approve 1000 USDT"

ç”¨æˆ·æ ¹æœ¬ä¸çŸ¥é“ï¼š
	â€¢	ç»™è°ï¼Ÿ
	â€¢	ç»™å¤šå°‘ï¼Ÿ
	â€¢	æœ‰æ•ˆå¤šä¹…ï¼Ÿ

â¸»

EIP-712 çš„è§£å†³æ–¹æ¡ˆ

ç»“æ„åŒ–æ•°æ® + åŸŸéš”ç¦»
ç”¨æˆ·ç­¾çš„æ˜¯ï¼š

{
  owner: 0x123,
  spender: 0xabc,
  value: 1000,
  deadline: 123456
}

å…­ã€EIP-712 æ ¸å¿ƒç»“æ„å›¾ï¼ˆå¿…ç”»ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Domain â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name                  â”‚
â”‚ version               â”‚
â”‚ chainId               â”‚
â”‚ verifyingContract     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Permit(owner,spenderâ€¦)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Message â”€â”€â”€â”€â”€â”€â”€â”
â”‚ owner, value, nonce...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘‰ Domain = é˜²é‡æ”¾æ ¸å¿ƒ

â¸»

ä¸ƒã€EIP-712 å®æˆ˜ï¼ˆethers v6ï¼‰

1ï¸âƒ£ å®šä¹‰ Domain
const domain = {
  name: 'MyDApp',
  version: '1',
  chainId: 1,
  verifyingContract: '0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC'
}

2ï¸âƒ£ å®šä¹‰ Types
const types = {
  Permit: [
    { name: 'owner', type: 'address' },
    { name: 'spender', type: 'address' },
    { name: 'value', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' }
  ]
}


â¸»

3ï¸âƒ£ ç­¾å
```js
const message = {
  owner: wallet.address,
  spender: '0xabc...',
  value: 1000n,
  nonce: 1n,
  deadline: 9999999999n
}

const sig = await wallet.signTypedData(domain, types, message)
```


â¸»

4ï¸âƒ£ éªŒç­¾
```js
import { verifyTypedData } from 'ethers'

const recovered = verifyTypedData(domain, types, message, sig)
```

å…«ã€EIP-712 åœ¨çœŸå®ä¸–ç•Œçš„ç”¨é€”

Uniswap / Permit / Seaport
	â€¢	approve ä¸ä¸Šé“¾
	â€¢	èŠ‚çœ gas
	â€¢	é˜²æ— é™æˆæƒ

ğŸ‘‰ æœ¬è´¨ï¼š
å…ˆç­¾å â†’ åæ‰§è¡Œ

ä¹ã€å®‰å…¨ & æ”»å‡»æ¨¡å‹ï¼ˆé¢è¯•å¿…æ€ï¼‰

âŒ å±é™©ç­¾å
	â€¢	æ—  nonce
	â€¢	æ—  deadline
	â€¢	æ—  domain

âœ… å®‰å…¨ç­¾å
	â€¢	EIP-712
	â€¢	domain separator åŸŸéš”ç¦»
	â€¢	å•æ¬¡æœ‰æ•ˆ

â¸»

åã€é¢è¯•å¿…èƒŒç­”æ¡ˆï¼ˆç›´æ¥ç”¨ï¼‰

Qï¼šWeb3 ç™»å½•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

æ ‡å‡†å›ç­”ï¼š

æœåŠ¡ç«¯ç”Ÿæˆéšæœº nonceï¼Œ
ç”¨æˆ·ç”¨é’±åŒ…ç­¾åè¯¥ nonceï¼Œ
æœåŠ¡ç«¯é€šè¿‡éªŒç­¾æ¢å¤åœ°å€ï¼Œ
éªŒè¯é€šè¿‡å³å®Œæˆèº«ä»½è®¤è¯ï¼Œ
å…¨ç¨‹æ— éœ€è´¦å·å¯†ç ã€‚

â¸»

Qï¼šEIP-712 è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

æ ‡å‡†å›ç­”ï¼š

å®ƒè§£å†³äº†ç­¾åå†…å®¹ä¸å¯è¯»ã€å¯è¢«é‡æ”¾çš„é—®é¢˜ï¼Œ
é€šè¿‡ç»“æ„åŒ–æ•°æ®å’Œ domain éš”ç¦»ï¼Œ
ä¿è¯ç­¾ååªåœ¨æŒ‡å®šåˆçº¦å’Œé“¾ä¸Šæœ‰æ•ˆã€‚

â¸»

åä¸€ã€ä»Šå¤©ä½ å¿…é¡»çœŸçš„â€œåƒé€â€çš„ 3 ä»¶äº‹

1ï¸âƒ£ ç­¾å = èº«ä»½è¯æ˜
2ï¸âƒ£ éªŒç­¾ = åœ°å€æ¢å¤
3ï¸âƒ£ EIP-712 = DeFi å®‰å…¨åŸºç¡€
