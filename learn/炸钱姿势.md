
---

## 交易系统「炸钱」的真实方式（工程视角）

- 炸钱不是黑客
- 炸钱是你自己写的逻辑在极端情况下把钱算错

---

## 最常见的 5 种「炸钱姿势」

---

### 1️⃣ 冻结 ≠ 真实成交（新手第一炸）

#### 错误理解
- “我已经 freeze 了，就等于买到了”

#### 实际情况
- 你冻结 200 USDT
- 只成交了 1 BTC 中的 0.3 BTC
- 剩下的钱没有释放 / 释放多了

#### 炸点在哪里
- used 没按成交逐步减少
- free 没按比例返还

### 2️⃣ 部分成交没算清（最隐蔽）
#### 场景
- 买 2 BTC @ 100
- 第一次成交：1 BTC @ 90
- 第二次成交：1 BTC @ 110

#### 新手错误
- 成交价 = 最后一次成交价

#### 正确
- 成交均价 = (90 + 110) / 2 = 100

#### 炸钱结果
- 成本错 → 盈亏错 → 风控错 → 爆仓

### 3️⃣ 撤单时把「已成交的冻结」也释放了
#### 错误代码示意
```js
release(order.frozenAmount)
```
#### 实际情况
- 冻结 200
- 已成交用掉 120
- 还能释放的只有 80

#### 炸钱效果
- free = total + 120  // 钱凭空出现
> 这是交易所事故级错误

### 4️⃣ 重复成交事件（WS 重放）
#### 场景
- WebSocket 重连
- 成交事件又发了一遍

#### 新手代码
```js
applyTrade(trade)
```
#### 正确做法
```js
if (!processedTradeIds.has(tradeId)) {
  applyTrade(trade)
}
```
#### 炸钱表现
- 同一笔成交算了两次
- 余额直接翻倍 / 清零

### 5️⃣ free + used != total（终极炸点）
#### 现象
- free + used ≠ total（只要出现一次）

#### 意味着
- 对账永远对不上
- 无法修复
- 只能人工赔钱

